services:
  nginx-proxy:
    image: nginxproxy/nginx-proxy:latest
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - certs:/etc/nginx/certs:ro
      - vhost.d:/etc/nginx/vhost.d
      - ../nginx-proxy/conf.d/client_max_body_size.conf:/etc/nginx/conf.d/40-client-max-body-size.conf:ro
      - html:/usr/share/nginx/html
      - /var/run/docker.sock:/tmp/docker.sock:ro
    restart: unless-stopped

  acme-companion:
    image: nginxproxy/acme-companion:latest
    container_name: acme-companion
    env_file:
      - ../.env
    environment:
      NGINX_PROXY_CONTAINER: nginx-proxy
      DEFAULT_EMAIL: ${LETSENCRYPT_EMAIL:-}
    volumes:
      - certs:/etc/nginx/certs:rw
      - vhost.d:/etc/nginx/vhost.d:rw
      - html:/usr/share/nginx/html:rw
      - acme:/etc/acme.sh
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - nginx-proxy
    restart: unless-stopped

  api:
    image: ${RIZM_API_IMAGE:-kabekenputer/keel-api:latest}
    env_file:
      - ../.env
    environment:
      KEEL_BIND: "0.0.0.0:48888"
      KEEL_DB_PATH: "/data/keel.sqlite3"
      KEEL_COOKIE_SECURE: ${KEEL_COOKIE_SECURE:-true}
    volumes:
      - rizm-data:/data
    restart: unless-stopped

  web:
    image: ${RIZM_WEB_IMAGE:-kabekenputer/keel-web:latest}
    env_file:
      - ../.env
    environment:
      VIRTUAL_HOST: ${APP_DOMAIN:-}
      LETSENCRYPT_HOST: ${APP_DOMAIN:-}
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL:-}
      VIRTUAL_PORT: 80
    depends_on:
      - api
      - nginx-proxy
    restart: unless-stopped

volumes:
  rizm-data:
  certs:
  vhost.d:
  html:
  acme:
